<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>グッズ販売</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
  body { font-family: sans-serif; padding: 20px; }

  #total, #change, #receivedLabel {
    font-size: 1.4em;
    font-weight: bold;
    margin-top: 15px;
  }

  #change {
    min-height: 1.4em;
  }

  .delete-btn {
    padding: 3px 8px;
    font-size: 0.8em;
  }

  button {
    touch-action: manipulation;
  }
</style>
</head>
<body>

<!-- 상단 바 -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">グッズ販売</h2>
  <button id="resetBtn" class="btn btn-danger" onclick="resetAll()">すべてクリア</button>
</div>

<!-- 상품 헤더 -->
<div class="row fw-bold border-bottom pb-2 mb-2">
  <div class="col-5">商品名</div>
  <div class="col-3 text-end">単価</div>
  <div class="col-4 text-end">数量</div>
</div>

<!-- 상품 리스트 -->
<div id="items"></div>

<!-- 합계 -->
<div id="total" class="mt-3">合計: 0円</div>

<!-- 받은 금액 -->
<div id="receivedLabel" class="mt-3">受取金額:</div>

<div class="d-flex align-items-center gap-2 mt-1">
  <input 
    type="text"
    id="received"
    inputmode="numeric"
    pattern="[0-9]*"
    class="form-control"
    style="max-width: 180px; font-size:16px;"
  >
  <button class="btn btn-primary" style="font-size:1em; padding:10px 20px;" onclick="calcChange()">計算</button>
</div>

<!-- 거스름돈 -->
<div id="change" class="mt-2"></div>

<!-- 이력 -->
<div id="history" class="mt-4">
  <h3>計算履歴</h3>
  <div id="historyList"></div>
</div>

<script>
let historyCount = 0;

const products = [
  { name: "上諏訪の女", price: 1250 },
  { name: "捨てちまえ", price: 1350 },
  { name: "衿子", price: 1500 },
  { name: "天野涼 ペンライト", price: 3000 }
];

const itemsDiv = document.getElementById("items");

products.forEach((p, idx) => {
  const row = document.createElement("div");
  row.className = "row align-items-center mb-2";

  row.innerHTML = `
    <div class="col-5">${p.name}</div>
    <div class="col-3 text-end">${p.price.toLocaleString()}円</div>
    <div class="col-4 text-end">
      <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${idx}, -1)">
        <i class="fa-solid fa-minus"></i>
      </button>
      <span id="qty${idx}" class="mx-2">0</span>
      <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${idx}, 1)">
        <i class="fa-solid fa-plus"></i>
      </button>
    </div>
  `;
  itemsDiv.appendChild(row);
});

function changeQty(i, delta) {
  const qtySpan = document.getElementById("qty" + i);
  let qty = parseInt(qtySpan.textContent) + delta;
  if (qty < 0) qty = 0;
  qtySpan.textContent = qty;
  calcTotal();
}

function calcTotal() {
  let sum = 0;
  products.forEach((p, i) => {
    const qty = parseInt(document.getElementById("qty" + i).textContent);
    sum += p.price * qty;
  });
  document.getElementById("total").textContent = `合計: ${sum.toLocaleString()}円`;
  return sum;
}

function getReceivedValue() {
  const raw = document.getElementById("received").value.replace(/,/g, "");
  return raw === "" ? 0 : parseInt(raw);
}

function calcChange() {
  const received = getReceivedValue();
  const total = calcTotal();
  const change = received - total;

  if (received === 0) {
    document.getElementById("change").textContent = "受取金額を入力してください。";
    return;
  }

  if (change < 0) {
    document.getElementById("change").textContent = `不足: ${Math.abs(change).toLocaleString()}円`;
  } else {
    document.getElementById("change").textContent = `お釣り: ${change.toLocaleString()}円`;
  }

  saveHistory(received, total);

  window.scrollTo({ top: 0, behavior: "smooth" });
}

function resetAll() {
  products.forEach((_, i) => {
    document.getElementById("qty" + i).textContent = 0;
  });
  document.getElementById("received").value = "";
  document.getElementById("change").textContent = "";
  calcTotal();
}

function saveHistory(received, total) {
  historyCount++;

  const time = new Date().toLocaleTimeString("ja-JP", { hour12: false });
  const change = received - total;

  let qtyList = "";
  products.forEach((p, i) => {
    const qty = parseInt(document.getElementById("qty" + i).textContent);
    qtyList += `${p.name}: ${qty}　`;
  });

  const div = document.createElement("div");
  div.className = "history-item mt-3";
  div.id = "history-" + historyCount;

  div.innerHTML = `
    <div><strong>No.${historyCount}</strong></div>
    <div><strong>時間:</strong> ${time}</div>
    <div><strong>受取:</strong> ${received.toLocaleString()}円</div>
    <div><strong>合計:</strong> ${total.toLocaleString()}円</div>
    <div><strong>お釣り:</strong> ${change.toLocaleString()}円</div>
    <div><strong>数量:</strong> ${qtyList}</div>
    <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteHistory(${historyCount})">削除</button>
  `;

  document.getElementById("historyList").prepend(div);
}

function deleteHistory(id) {
  const item = document.getElementById("history-" + id);
  if (item) item.remove();
}

/* 포커스 인: 콤마 제거 */
document.getElementById("received").addEventListener("focus", function () {
  this.value = this.value.replace(/,/g, "");
});

/* 포커스 아웃: 콤마 적용 + 자동 계산 + 화면 상단 이동 */
document.getElementById("received").addEventListener("blur", function () {
  let v = this.value.replace(/,/g, "");
  if (v !== "" && !isNaN(v)) {
    this.value = Number(v).toLocaleString();
  }

  calcChange();
  window.scrollTo({ top: 0, behavior: "smooth" });
});

/* Enter(완료) 키 */
document.getElementById("received").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    calcChange();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
});
</script>

</body>
</html>
