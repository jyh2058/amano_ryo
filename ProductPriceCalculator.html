<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>グッズ販売</title>
<style>
  body { font-family: sans-serif; padding: 20px; }

  .header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 10px;
    border-bottom: 2px solid #ccc;
    padding-bottom: 6px;
  }
  .h-name { width: 40%; }
  .h-price { width: 20%; text-align: right; }
  .h-qty { width: 40%; text-align: right; }

  .item { display: flex; justify-content: space-between; margin: 12px 0; }
  .name { width: 40%; }
  .price { width: 20%; text-align: right; }
  .qty { width: 40%; text-align: right; }

  button {
    min-width: 32px;
    min-height: 32px;
    padding: 0 10px;
    touch-action: manipulation;
  }

  /* 합계 / 받은 금액 / 거스름돈 폰트 통일 */
  #total, #change, #receivedLabel {
    font-size: 1.4em;
    font-weight: bold;
    margin-top: 15px;
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  #resetBtn {
    padding: 10px 20px;
    font-size: 1em;
  }

  #history {
    margin-top: 30px;
    border-top: 2px solid #ccc;
    padding-top: 15px;
  }

  .history-item {
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px dashed #aaa;
  }

  .delete-btn {
    margin-left: 10px;
    padding: 3px 8px;
    font-size: 0.8em;
  }

  #change {
    min-height: 1.4em;
    font-size: 1.4em;
    font-weight: bold;
    margin-top: 15px;
  }
</style>
</head>
<body>

<div class="top-bar">
  <h2>グッズ販売</h2>
  <button id="resetBtn" onclick="resetAll()">すべてクリア</button>
</div>

<div class="header">
  <div class="h-name">商品名</div>
  <div class="h-price">単価</div>
  <div class="h-qty">数量</div>
</div>

<div id="items"></div>

<div id="total">合計: 0円</div>

<!-- 받은 금액 입력 -->
<div id="receivedLabel">受取金額:</div>
<input 
  type="number" 
  id="received" 
  inputmode="numeric" 
  pattern="[0-9]*" 
  style="width:150px; font-size:16px; touch-action:manipulation;"
>
<button onclick="calcChange()" style="font-size:1em; padding:10px 20px;">計算</button>

<!-- 거스름돈 표시 -->
<div id="change"></div>

<!-- 이력 -->
<div id="history">
  <h3>計算履歴</h3>
  <div id="historyList"></div>
</div>

<script>
let historyCount = 0;

const products = [
  { name: "上諏訪の女", price: 1250 },
  { name: "捨てちまえ", price: 1350 },
  { name: "衿子", price: 1500 },
  { name: "天野涼 ペンライト", price: 3000 }
];

const itemsDiv = document.getElementById("items");

products.forEach((p, idx) => {
  const row = document.createElement("div");
  row.className = "item";
  row.innerHTML = `
    <div class="name">${p.name}</div>
    <div class="price">${p.price}円</div>
    <div class="qty">
      <button onclick="changeQty(${idx}, -1)">-</button>
      <span id="qty${idx}">0</span>
      <button onclick="changeQty(${idx}, 1)">+</button>
    </div>
  `;
  itemsDiv.appendChild(row);
});

function changeQty(i, delta) {
  const qtySpan = document.getElementById("qty" + i);
  let qty = parseInt(qtySpan.textContent) + delta;
  if (qty < 0) qty = 0;
  qtySpan.textContent = qty;
  calcTotal();
}

function calcTotal() {
  let sum = 0;
  products.forEach((p, i) => {
    const qty = parseInt(document.getElementById("qty" + i).textContent);
    sum += p.price * qty;
  });
  document.getElementById("total").textContent = `合計: ${sum.toLocaleString()}円`;
  return sum;
}

function calcChange() {
  const received = parseInt(document.getElementById("received").value || 0);
  const total = calcTotal();
  const change = received - total;

  if (received === 0) {
    document.getElementById("change").textContent = "受取金額を入力してください。";
    return;
  }

  if (change < 0) {
    document.getElementById("change").textContent = `不足: ${Math.abs(change)}円`;
  } else {
    document.getElementById("change").textContent = `お釣り: ${change}円`;
  }

  saveHistory(received, total);

  // ★ 숫자 키보드 닫힌 후 화면이 아래로 밀리는 문제 해결
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function resetAll() {
  products.forEach((_, i) => {
    document.getElementById("qty" + i).textContent = 0;
  });
  document.getElementById("received").value = "";
  document.getElementById("change").textContent = "";
  calcTotal();
}

function saveHistory(received, total) {
  historyCount++;

  const time = new Date().toLocaleTimeString("ja-JP", { hour12: false });

  const change = received - total;  // ← 거스름돈 계산 추가

  let qtyList = "";
  products.forEach((p, i) => {
    const qty = parseInt(document.getElementById("qty" + i).textContent);
    qtyList += `${p.name}: ${qty}　`;
  });

  const div = document.createElement("div");
  div.className = "history-item";
  div.id = "history-" + historyCount;

  div.innerHTML = `
    <div><strong>No.${historyCount}</strong></div>
    <div><strong>時間:</strong> ${time}</div>
    <div><strong>受取:</strong> ${received}円</div>
    <div><strong>合計:</strong> ${total}円</div>
    <div><strong>お釣り:</strong> ${change}円</div>   <!-- ★ 추가된 부분 -->
    <div><strong>数量:</strong> ${qtyList}</div>
    <button class="delete-btn" onclick="deleteHistory(${historyCount})">削除</button>
  `;

  document.getElementById("historyList").prepend(div);
}

function deleteHistory(id) {
  const item = document.getElementById("history-" + id);
  if (item) item.remove();
}
</script>

</body>
</html>
