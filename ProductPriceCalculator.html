<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- OG Tags -->
<meta property="og:title" content="グッズ販売 計算ツール">
<meta property="og:description" content="グッズ販売の計算ツールです。">
<meta property="og:url" content="https://jyh2058.github.io/amano_ryo/">
<meta property="og:type" content="website">
<meta property="og:image" content="https://jyh2058.github.io/amano_ryo/og-image.jpg">

<title>グッズ販売</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
  body { font-family: sans-serif; padding: 5px; }
  #total, #change { font-size: 1.4em; font-weight: bold; }
  #change { min-height: 28px; display: flex; align-items: center; }
  #receivedLabel { font-size: 1.4em; font-weight: bold; height: 38px; }
  .qty-buttons { white-space: nowrap; }
  button { touch-action: manipulation; }
</style>
</head>
<body>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">グッズ販売</h2>
  <button id="resetBtn" class="btn btn-outline-danger" onclick="resetAll()">計算内容を消去</button>
</div>

<!-- Table Header -->
<div class="row fw-bold border-bottom pb-2 mb-2">
  <div class="col-5">商品名</div>
  <div class="col-3 text-end">単価</div>
  <div class="col-4 text-end">数量</div>
</div>

<!-- 기본 상품 -->
<div id="items"></div>

<!-- Accordion -->
<div class="accordion mt-2" id="accordion01">

  <!-- その他商品 -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingExtra">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExtra">
        その他商品
      </button>
    </h2>
    <div id="collapseExtra" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body p-2">
        <div id="extraItems"></div>
      </div>
    </div>
  </div>

</div>

<!-- Total -->
<div id="total" class="mt-2">合計: 0円</div>

<!-- Received -->
<div class="d-flex align-items-center flex-nowrap mt-2" style="gap:6px;">
  <div id="receivedLabel" class="d-flex align-items-center flex-shrink-0">受取金額:</div>
  <input type="text" id="received" inputmode="numeric" pattern="[0-9]*" class="form-control flex-shrink-1" style="max-width: 100px; font-size:16px;">
  <button class="btn btn-outline-primary flex-shrink-0" onclick="calcChange()">計算</button>
  <button class="btn btn-outline-success flex-shrink-0" onclick="setExactAmount()">ちょうど</button>
</div>

<!-- Change -->
<div class="d-flex align-items-center mt-2" style="gap:8px;">
  <div id="change" class="flex-grow-1"></div>

  <button id="finishBtn" class="btn btn-outline-danger flex-shrink-0"
          onclick="resetAll()" style="display:none;">
    おわり
  </button>
</div>

<!-- Accordion -->
<div class="accordion mt-3" id="accordion02">
  
  <!-- 販売集計 -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingSummary">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary">
        販売集計
      </button>
    </h2>
    <div id="collapseSummary" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body p-2">
        <div id="totalSales" class="mb-2"><strong>総売上金額:</strong> 0円</div>
        <div id="productQty"></div>
      </div>
    </div>
  </div>

  <!-- 計算履歴 -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingHistory">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory">
        計算履歴
      </button>
    </h2>
    <div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#mainAccordion">
      <div class="accordion-body p-2">
        <div id="historyList"></div>
      </div>
    </div>
  </div>

</div>

<!-- Buttons -->
<div class="d-flex gap-2 mt-3">
  <button class="btn btn-outline-success btn-sm px-2 py-1 me-auto" onclick="shareLine()">
    LINE共有(集計・履歴)
  </button>

  <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="downloadCSV()">
    CSVダウンロード
  </button>

  <button class="btn btn-outline-danger btn-sm px-2 py-1" onclick="clearAllHistory()">
    全削除
  </button>
</div>

<script>
let historyArray = [];
let historyCount = 0;

/* 기본 상품 */
const products = [
  { name: "上諏訪の女", price: 1250 },
  { name: "捨てちまえ", price: 1350 },
  { name: "衿子", price: 1500 },
  { name: "天野涼 ペンライト", price: 3000 }
];

/* 기타 상품 */
const extraProducts = [
  { name: "電池(3本)", price: 100 },
  { name: "3/12大井町きゅりあんチケット", price: 4500 },
  { name: "3/18栃木野木チケット", price: 4500 },
  { name: "4/21神奈川港南チケット", price: 4500 }
];

const itemsDiv = document.getElementById("items");
const extraDiv = document.getElementById("extraItems");

/* 기본 상품 출력 */
products.forEach((p, idx) => {
  const row = document.createElement("div");
  row.className = "row align-items-center mb-2";
  row.innerHTML = `
    <div class="col-5">${p.name}</div>
    <div class="col-3 text-end">${p.price.toLocaleString()}円</div>
    <div class="col-4 text-end qty-buttons">
      <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${idx}, -1)"><i class="fa-solid fa-minus"></i></button>
      <span id="qty${idx}" class="mx-2">0</span>
      <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${idx}, 1)"><i class="fa-solid fa-plus"></i></button>
    </div>`;
  itemsDiv.appendChild(row);
});

/* 기타 상품 출력 */
extraProducts.forEach((p, idx) => {
  const row = document.createElement("div");
  row.className = "row align-items-center mb-2";
  row.innerHTML = `
    <div class="col-5">${p.name}</div>
    <div class="col-3 text-end">${p.price.toLocaleString()}円</div>
    <div class="col-4 text-end qty-buttons">
      <button class="btn btn-outline-secondary btn-sm" onclick="changeExtraQty(${idx}, -1)"><i class="fa-solid fa-minus"></i></button>
      <span id="extraQty${idx}" class="mx-2">0</span>
      <button class="btn btn-outline-secondary btn-sm" onclick="changeExtraQty(${idx}, 1)"><i class="fa-solid fa-plus"></i></button>
    </div>`;
  extraDiv.appendChild(row);
});

/* 수량 변경 */
function changeQty(i, delta) {
  const qtySpan = document.getElementById("qty" + i);
  let qty = parseInt(qtySpan.textContent) + delta;
  if (qty < 0) qty = 0;
  qtySpan.textContent = qty;
  calcTotal();
}

function changeExtraQty(i, delta) {
  const qtySpan = document.getElementById("extraQty" + i);
  let qty = parseInt(qtySpan.textContent) + delta;
  if (qty < 0) qty = 0;
  qtySpan.textContent = qty;
  calcTotal();
}

/* 합계 */
function calcTotal() {
  let sum = 0;
  products.forEach((p, i) => sum += p.price * parseInt(document.getElementById("qty" + i).textContent));
  extraProducts.forEach((p, i) => sum += p.price * parseInt(document.getElementById("extraQty" + i).textContent));
  document.getElementById("total").textContent = `合計: ${sum.toLocaleString()}円`;
  return sum;
}

/* 받은 금액 */
function getReceivedValue() {
  const raw = document.getElementById("received").value.replace(/,/g, "");
  return raw === "" ? 0 : parseInt(raw);
}

/* 계산 */
function calcChange() {
  const total = calcTotal();
  const received = getReceivedValue();
  const finishBtn = document.getElementById("finishBtn");

  // 기본적으로 숨김
  finishBtn.style.display = "none";

  if (total === 0) {
    document.getElementById("change").textContent = "数量を入力してください。";
    return;
  }

  if (received === 0) {
    document.getElementById("change").textContent = "受取金額を入力してください。";
    return;
  }

  const change = received - total;

  if (change < 0) {
    document.getElementById("change").textContent =
      `不足: ${Math.abs(change).toLocaleString()}円`;
    return;
  }

  // ⭐ 여기서만 おわり 버튼 표시
  finishBtn.style.display = "block";

  document.getElementById("change").textContent =
    `お釣り: ${change.toLocaleString()}円`;

  saveHistory(received, total);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ちょうど */
function setExactAmount() {
  const total = calcTotal();
  if (total === 0) return document.getElementById("change").textContent = "数量を入力してください。";
  document.getElementById("received").value = total.toLocaleString();
  calcChange();
}

/* 초기화 */
function resetAll() {
  products.forEach((_, i) => document.getElementById("qty" + i).textContent = 0);
  extraProducts.forEach((_, i) => document.getElementById("extraQty" + i).textContent = 0);
  document.getElementById("received").value = "";
  document.getElementById("change").textContent = "";
  finishBtn.style.display = "none";
  calcTotal();
}

/* 이력 저장 */
function saveHistory(received, total) {
  historyCount++;
  const time = new Date().toLocaleTimeString("ja-JP", { hour12: false });
  const change = received - total;

  const qtyObj = {};
  products.forEach((p, i) => qtyObj[p.name] = parseInt(document.getElementById("qty" + i).textContent));
  extraProducts.forEach((p, i) => qtyObj[p.name] = parseInt(document.getElementById("extraQty" + i).textContent));

  const entry = { id: historyCount, time, received, total, change, qty: qtyObj };
  historyArray.unshift(entry);
  localStorage.setItem("historyData", JSON.stringify(historyArray));

  renderHistory();
  updateSummary();
}

/* 이력 표시 */
function renderHistory() {
  const list = document.getElementById("historyList");
  list.innerHTML = "";

  historyArray.forEach(entry => {
    let qtyList = "";
    for (const key in entry.qty) qtyList += `${key}: ${entry.qty[key]}　`;

    const div = document.createElement("div");
    div.className = "history-item mt-3";
    div.innerHTML = `
      <div><strong>No.${entry.id}</strong></div>
      <div><strong>時間:</strong> ${entry.time}</div>
      <div><strong>受取:</strong> ${entry.received.toLocaleString()}円</div>
      <div><strong>合計:</strong> ${entry.total.toLocaleString()}円</div>
      <div><strong>お釣り:</strong> ${entry.change.toLocaleString()}円</div>
      <div><strong>数量:</strong> ${qtyList}</div>
      <button class="btn btn-outline-sm btn-outline-danger" onclick="deleteHistory(${entry.id})">削除</button>`;
    list.appendChild(div);
  });
}

/* 이력 삭제 */
function deleteHistory(id) {
  historyArray = historyArray.filter(e => e.id !== id);
  localStorage.setItem("historyData", JSON.stringify(historyArray));
  renderHistory();
  updateSummary();
}

/* 전체 삭제 */
function clearAllHistory() {
  if (!confirm("すべての履歴を削除しますか？")) return;
  historyArray = [];
  historyCount = 0;
  localStorage.removeItem("historyData");
  renderHistory();
  document.getElementById("totalSales").innerHTML = "<strong>総売上金額:</strong> 0円";
  document.getElementById("productQty").innerHTML = "";
}

/* LINE 공유 */
function shareLine() {
  if (historyArray.length === 0) return alert("共有する履歴がありません。");

  let productQtyTotals = {};
  let productSalesTotals = {};
  let totalSales = 0;

  [...products, ...extraProducts].forEach(p => {
    productQtyTotals[p.name] = 0;
    productSalesTotals[p.name] = 0;
  });

  historyArray.forEach(entry => {
    totalSales += entry.total;
    for (const name in entry.qty) {
      const qty = entry.qty[name];
      const price = [...products, ...extraProducts].find(p => p.name === name).price;
      productQtyTotals[name] += qty;
      productSalesTotals[name] += qty * price;
    }
  });

  let summaryText =
`==============================
【販売集計】
総売上金額: ${totalSales.toLocaleString()}円
`;

  for (const name in productQtyTotals) {
    summaryText += `${name}: ${productQtyTotals[name]}個 / ${productSalesTotals[name].toLocaleString()}円\n`;
  }

  summaryText += "==============================\n\n\n";

  let historyText = "";
  historyArray.forEach(entry => {
    let qtyList = "";
    for (const key in entry.qty) qtyList += `${key}:${entry.qty[key]} `;
    historyText +=
`----------------------------------------
 No: ${entry.id}
 時間: ${entry.time}
 受取: ${entry.received}円
 合計: ${entry.total}円
 お釣り: ${entry.change}円
----------------------------------------
 ${qtyList}
----------------------------------------

`;
  });

  const encoded = encodeURIComponent(summaryText + historyText);
  window.location.href = `line://msg/text/${encoded}`;
}

/* 집계 업데이트 */
function updateSummary() {
  if (historyArray.length === 0) {
    document.getElementById("totalSales").innerHTML = "<strong>総売上金額:</strong> 0円";
    document.getElementById("productQty").innerHTML = "";
    return;
  }

  let productQtyTotals = {};
  let productSalesTotals = {};
  let totalSales = 0;

  [...products, ...extraProducts].forEach(p => {
    productQtyTotals[p.name] = 0;
    productSalesTotals[p.name] = 0;
  });

  historyArray.forEach(entry => {
    totalSales += entry.total;
    for (const name in entry.qty) {
      const qty = entry.qty[name];
      const price = [...products, ...extraProducts].find(p => p.name === name).price;
      productQtyTotals[name] += qty;
      productSalesTotals[name] += qty * price;
    }
  });

  document.getElementById("totalSales").innerHTML =
    `<strong>総売上金額:</strong> ${totalSales.toLocaleString()}円`;

let html = `
  <strong>商品別販売:</strong>
  <table class="table table-bordered table-sm mt-2" style="font-size: smaller;">
    <thead>
      <tr>
        <th>商品名</th>
        <th class="text-end">販売数</th>
        <th class="text-end">販売金額</th>
      </tr>
    </thead>
    <tbody>
`;

for (const name in productQtyTotals) {
  html += `
    <tr>
      <td>${name}</td>
      <td class="text-end">${productQtyTotals[name]}個</td>
      <td class="text-end">${productSalesTotals[name].toLocaleString()}円</td>
    </tr>
  `;
}

html += `
    </tbody>
  </table>
`;

document.getElementById("productQty").innerHTML = html;

}

/* 콤마 처리 */
document.getElementById("received").addEventListener("focus", function () {
  this.value = this.value.replace(/,/g, "");
});

document.getElementById("received").addEventListener("blur", function () {
  let v = this.value.replace(/,/g, "");
  if (v !== "" && !isNaN(v)) this.value = Number(v).toLocaleString();
});

/* Enter → 계산 */
document.getElementById("received").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    calcChange();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
});

/* 로드 시 복원 */
window.onload = () => {
  const saved = localStorage.getItem("historyData");
  if (saved) {
    historyArray = JSON.parse(saved);
    historyCount = historyArray.length > 0 ? historyArray[0].id : 0;
    renderHistory();
    updateSummary();
  }
};

function downloadCSV() {
  if (historyArray.length === 0) {
    alert("ダウンロードする履歴がありません。");
    return;
  }

  let csv = "No,時間,受取,合計,お釣り,商品名,数量\n";

  historyArray.forEach(entry => {
    for (const name in entry.qty) {
      csv += [
        entry.id,
        entry.time,
        entry.received,
        entry.total,
        entry.change,
        name,
        entry.qty[name]
      ].join(",") + "\n";
    }
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "history.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
